#include <memory>
#include <systemc>
#include <ranges>
#include <csignal>
#include <vector>
#include <print>
#include <string_view>
#include <verilated.h>
#include <verilated_fst_sc.h>
#include "Vmips_r2000.h"
#include "util.hpp"

using namespace sc_core;
using namespace sc_dt;

struct Predictor {
    sc_bv<32> pc_wb { 0 };
    bool rd_wb { 0 };
    sc_bv<5> rd_address_wb { 0 };
    sc_bv<32> rd_data_wb { 0 };

    void operator==(const std::unique_ptr<Vmips_r2000>& dut) const {
        assert(pc_wb == dut->pc_wb.read());
        assert(rd_wb == dut->rd_wb.read());
        assert(rd_address_wb == dut->rd_address_wb.read());
        assert(rd_data_wb == dut->rd_data_wb.read());
    }
};

VerilatedFstSc* tfp = nullptr;

void print_pc(const std::unique_ptr<Vmips_r2000>& dut) {
    std::printf("dut->pc_wb.read(): %08X\n", dut->pc_wb.read().to_uint());
}

void print_ram(const std::unique_ptr<Vmips_r2000>& dut) {
    std::printf("------------//------------\n");
    for(const auto& [i, port]: std::views::enumerate(dut->ram)) {
        if(i % 4 == 0) {
            std::printf("\n[%03X]: ", i);
        }
        std::printf("%02X ", port.read().to_uint());
    }
    std::printf("\n");
}

void print_reg_file(const std::unique_ptr<Vmips_r2000>& dut) {
    const std::array<std::string_view, 31> names {
        "at",
        "v0",
        "v1",
        "a0",
        "a1",
        "a2",
        "a3",
        "t0",
        "t1",
        "t2",
        "t3",
        "t4",
        "t5",
        "t6",
        "t7",
        "s0",
        "s1",
        "s2",
        "s3",
        "s4",
        "s5",
        "s6",
        "s7",
        "t8",
        "t9",
        "k0",
        "k1",
        "gp",
        "sp",
        "s8",
        "ra",
    };
    for(const auto& [name, port]: std::views::zip(names, dut->reg_file)) {
        std::printf("%s: %08X\n", name.data(), port.read().to_uint());
    }
}

int sc_main(int argc, char* argv[]) {
    Verilated::debug(0);
    Verilated::randReset(2);
    Verilated::traceEverOn(true);
    Verilated::commandArgs(argc, argv);
    std::ios::sync_with_stdio();

    // inputs
    sc_clock clk{ "clk", sc_time { 10.0, SC_NS }, 0.5, sc_time { 3.0, SC_NS } };
    sc_signal<bool> rst;
    const std::vector<uint8_t> ROM {
        0x3c,
        0x1d,
        0x80,
        0x00,
        0x27,
        0xbd,
        0x00,
        0x80,
        0x3c,
        0x08,
        0x80,
        0x00,
        0x25,
        0x08,
        0x00,
        0x00,
        0x3c,
        0x09,
        0x80,
        0x00,
        0x25,
        0x29,
        0x00,
        0x00,
        0x01,
        0x09,
        0x08,
        0x2a,
        0x10,
        0x20,
        0x00,
        0x05,
        0x00,
        0x00,
        0x00,
        0x00,
        0xad,
        0x00,
        0x00,
        0x00,
        0x25,
        0x08,
        0x00,
        0x04,
        0x08,
        0x00,
        0x00,
        0x06,
        0x00,
        0x00,
        0x00,
        0x00,
        0x3c,
        0x08,
        0x80,
        0x00,
        0x25,
        0x08,
        0x04,
        0x00,
        0x3c,
        0x09,
        0x80,
        0x00,
        0x25,
        0x29,
        0x00,
        0x00,
        0x3c,
        0x0a,
        0x80,
        0x00,
        0x25,
        0x4a,
        0x00,
        0x00,
        0x01,
        0x2a,
        0x08,
        0x2a,
        0x10,
        0x20,
        0x00,
        0x0a,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x8d,
        0x0b,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0xad,
        0x2b,
        0x00,
        0x00,
        0x25,
        0x08,
        0x00,
        0x04,
        0x25,
        0x29,
        0x00,
        0x04,
        0x08,
        0x00,
        0x00,
        0x13,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x0c,
        0x00,
        0x00,
        0xb2,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x10,
        0x00,
        0xff,
        0xff,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x27,
        0xbd,
        0xff,
        0xf0,
        0xaf,
        0xbe,
        0x00,
        0x0c,
        0x03,
        0xa0,
        0xf0,
        0x25,
        0xaf,
        0xc4,
        0x00,
        0x10,
        0xaf,
        0xc5,
        0x00,
        0x14,
        0xaf,
        0xc0,
        0x00,
        0x00,
        0x10,
        0x00,
        0x00,
        0x1b,
        0x00,
        0x00,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc3,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x10,
        0x21,
        0x8c,
        0x43,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0x00,
        0x01,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc4,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x82,
        0x10,
        0x21,
        0x8c,
        0x42,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x43,
        0x10,
        0x2b,
        0x10,
        0x40,
        0x00,
        0x04,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x10,
        0x25,
        0x10,
        0x00,
        0x00,
        0x0e,
        0x00,
        0x00,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0x00,
        0x01,
        0xaf,
        0xc2,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x14,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0xff,
        0xff,
        0x8f,
        0xc3,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x10,
        0x2b,
        0x14,
        0x40,
        0xff,
        0xdf,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x02,
        0x00,
        0x01,
        0x03,
        0xc0,
        0xe8,
        0x25,
        0x8f,
        0xbe,
        0x00,
        0x0c,
        0x27,
        0xbd,
        0x00,
        0x10,
        0x03,
        0xe0,
        0x00,
        0x08,
        0x00,
        0x00,
        0x00,
        0x00,
        0x27,
        0xbd,
        0xff,
        0xe0,
        0xaf,
        0xbf,
        0x00,
        0x1c,
        0xaf,
        0xbe,
        0x00,
        0x18,
        0x03,
        0xa0,
        0xf0,
        0x25,
        0xaf,
        0xc4,
        0x00,
        0x20,
        0xaf,
        0xc5,
        0x00,
        0x24,
        0x10,
        0x00,
        0x00,
        0x46,
        0x00,
        0x00,
        0x00,
        0x00,
        0xaf,
        0xc0,
        0x00,
        0x10,
        0x10,
        0x00,
        0x00,
        0x3b,
        0x00,
        0x00,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc3,
        0x00,
        0x20,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x10,
        0x21,
        0x8c,
        0x43,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0x00,
        0x01,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc4,
        0x00,
        0x20,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x82,
        0x10,
        0x21,
        0x8c,
        0x42,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x43,
        0x10,
        0x2b,
        0x10,
        0x40,
        0x00,
        0x24,
        0x00,
        0x00,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc3,
        0x00,
        0x20,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x10,
        0x21,
        0x8c,
        0x42,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0xaf,
        0xc2,
        0x00,
        0x14,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0x00,
        0x01,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc3,
        0x00,
        0x20,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x18,
        0x21,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc4,
        0x00,
        0x20,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x82,
        0x10,
        0x21,
        0x8c,
        0x63,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0xac,
        0x43,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0x00,
        0x01,
        0x00,
        0x02,
        0x10,
        0x80,
        0x8f,
        0xc3,
        0x00,
        0x20,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x10,
        0x21,
        0x8f,
        0xc3,
        0x00,
        0x14,
        0x00,
        0x00,
        0x00,
        0x00,
        0xac,
        0x43,
        0x00,
        0x00,
        0x8f,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0x00,
        0x01,
        0xaf,
        0xc2,
        0x00,
        0x10,
        0x8f,
        0xc2,
        0x00,
        0x24,
        0x00,
        0x00,
        0x00,
        0x00,
        0x24,
        0x42,
        0xff,
        0xff,
        0x8f,
        0xc3,
        0x00,
        0x10,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x62,
        0x10,
        0x2b,
        0x14,
        0x40,
        0xff,
        0xbf,
        0x00,
        0x00,
        0x00,
        0x00,
        0x8f,
        0xc5,
        0x00,
        0x24,
        0x8f,
        0xc4,
        0x00,
        0x20,
        0x0c,
        0x00,
        0x00,
        0x25,
        0x00,
        0x00,
        0x00,
        0x00,
        0x38,
        0x42,
        0x00,
        0x01,
        0x30,
        0x42,
        0x00,
        0xff,
        0x14,
        0x40,
        0xff,
        0xb4,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x03,
        0xc0,
        0xe8,
        0x25,
        0x8f,
        0xbf,
        0x00,
        0x1c,
        0x8f,
        0xbe,
        0x00,
        0x18,
        0x27,
        0xbd,
        0x00,
        0x20,
        0x03,
        0xe0,
        0x00,
        0x08,
        0x00,
        0x00,
        0x00,
        0x00,
        0x27,
        0xbd,
        0xff,
        0xc8,
        0xaf,
        0xbf,
        0x00,
        0x34,
        0xaf,
        0xbe,
        0x00,
        0x30,
        0x03,
        0xa0,
        0xf0,
        0x25,
        0x24,
        0x02,
        0x00,
        0x02,
        0xaf,
        0xc2,
        0x00,
        0x10,
        0x24,
        0x02,
        0x00,
        0x05,
        0xaf,
        0xc2,
        0x00,
        0x14,
        0x24,
        0x02,
        0x00,
        0x01,
        0xaf,
        0xc2,
        0x00,
        0x18,
        0x24,
        0x02,
        0x00,
        0x0f,
        0xaf,
        0xc2,
        0x00,
        0x1c,
        0x24,
        0x02,
        0x00,
        0x07,
        0xaf,
        0xc2,
        0x00,
        0x20,
        0x24,
        0x02,
        0x00,
        0x03,
        0xaf,
        0xc2,
        0x00,
        0x24,
        0x24,
        0x02,
        0x00,
        0x0a,
        0xaf,
        0xc2,
        0x00,
        0x28,
        0xaf,
        0xc0,
        0x00,
        0x2c,
        0x24,
        0x05,
        0x00,
        0x08,
        0x27,
        0xc2,
        0x00,
        0x10,
        0x00,
        0x40,
        0x20,
        0x25,
        0x0c,
        0x00,
        0x00,
        0x55,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x00,
        0x10,
        0x25,
        0x03,
        0xc0,
        0xe8,
        0x25,
        0x8f,
        0xbf,
        0x00,
        0x34,
        0x8f,
        0xbe,
        0x00,
        0x30,
        0x27,
        0xbd,
        0x00,
        0x38,
        0x03,
        0xe0,
        0x00,
        0x08,
        0x00,
        0x00,
        0x00,
        0x00,
    };
    assert((ROM.size() > 4) && ((ROM.size() % 4) == 0));
    std::vector<sc_signal<sc_bv<8>>> rom(std::extent_v<std::remove_reference_t<decltype(Vmips_r2000::rom)>>);
    sc_signal<bool> stall;

    // outputs
    sc_signal<sc_bv<32>> pc_wb;
    std::vector<sc_signal<sc_bv<8>>> ram(std::extent_v<std::remove_reference_t<decltype(Vmips_r2000::ram)>>);
    std::vector<sc_signal<sc_bv<32>>> reg_file(std::extent_v<std::remove_reference_t<decltype(Vmips_r2000::reg_file)>>);
    sc_signal<bool> rd_wb;
    sc_signal<sc_bv<5>> rd_address_wb;
    sc_signal<sc_bv<32>> rd_data_wb;

    const std::unique_ptr<Vmips_r2000> dut{new Vmips_r2000{"bubble_sort_context"}};

    // inputs
    dut->clk(clk);
    dut->rst(rst);
    for(const auto& [port, sig]: std::views::zip(dut->rom, rom)) {
        port(sig);
    }
    dut->stall(stall);

    // outputs
    dut->pc_wb(pc_wb);
    for(const auto& [port, sig]: std::views::zip(dut->ram, ram)) {
        port(sig);
    }
    for(const auto& [port, sig]: std::views::zip(dut->reg_file, reg_file)) {
        port(sig);
    }
    dut->rd_wb(rd_wb);
    dut->rd_address_wb(rd_address_wb);
    dut->rd_data_wb(rd_data_wb);


    rst = 1;
    stall = 0;
    for(const auto& [sig, data]: std::views::zip(rom, ROM)) {
        sig = data;
    }

    sc_start(SC_ZERO_TIME);
    Verilated::mkdir("logs");
    tfp = new VerilatedFstSc;
    dut->trace(tfp, 99);
    tfp->open("logs/bubble_sort_tb.fst");
    std::signal(SIGABRT, [](int signal) { if(tfp) { tfp->flush(); tfp->close(); }});

    // reset
    sc_start(1, SC_NS);
    rst = 0;
    sc_start(1, SC_NS);
    Predictor{} == dut;
    rst = 1;
    sc_start(1, SC_NS);

    sc_start(5, SC_NS);
    sc_start(5, SC_NS);
    sc_start(5, SC_NS);
    sc_start(5, SC_NS);
    sc_start(5, SC_NS);
    sc_start(5, SC_NS);

    // clear_bss
    for(const auto i: std::views::iota(0U, 9U)) {
        sc_start(5, SC_NS);
        sc_start(5, SC_NS);
    }
    // clear_bss_done
    
    // copy_data
    for(const auto i: std::views::iota(0U, 9U)) {
        sc_start(5, SC_NS);
        sc_start(5, SC_NS);
    }

    // copy_data_done
    sc_start(5, SC_NS);
    sc_start(5, SC_NS);
    Predictor {
        .pc_wb = 0x7C,
        .rd_wb = true,
        .rd_address_wb = 31,
        .rd_data_wb = 0x7C + 4 + 4,
    } == dut;
    sc_start(5, SC_NS);
    sc_start(5, SC_NS);

    // main before calling jal bubble_sort
    while(dut->pc_wb.read().to_uint() < 0x320U) {
        sc_start(5, SC_NS);
        sc_start(5, SC_NS);
    }

    const std::array<uint32_t, 8> DATA { 0x2, 0x5, 0x1, 0xF, 0x7, 0x3, 0xA, 0x0 };
    const auto& get_array_from_ram_stack = [&]() {
        return dut->ram
            | std::views::reverse
            | std::views::drop(2 * 4)
            | std::views::take(8 * 4)
            | std::views::reverse
            | std::views::chunk(4)
            | std::views::transform([](const auto& e) {
                return cc(e[0].read(), e[1].read(), e[2].read(), e[3].read()).to_uint();
            }
        );
    };
    assert(std::ranges::equal(DATA, get_array_from_ram_stack()));

    for(uint32_t hang = 0; hang < 3; hang += [&]() { return dut->pc_wb.read() == 0x8CU ? 1 : 0; }()) {
        sc_start(5, SC_NS);
        sc_start(5, SC_NS);
    }
    assert(std::ranges::equal(
        [&]() {
            auto copy = DATA;
            std::ranges::sort(copy);
            return copy; 
        }(),
        get_array_from_ram_stack()
    ));

    if(tfp) { tfp->flush(); tfp->close(); }
    dut->final();
    return 0;
}